{"version":3,"sources":["../../src/commands/multiBundle.ts"],"names":["multiBundleCommand","runtime","command","describe","builder","dev","description","default","type","platform","minify","config","progress","choices","handler","argv","assetsDest","bundleOutput","sourcemapOutput","skipHostCheck","maxWorkers","process","env","HAUL_PLATFORM","directory","cwd","configPath","normalizedProjectConfigBuilder","root","bundleMode","bundleTarget","undefined","optionsWithProgress","stdin","isTTY","projectConfig","bundleName","bundleConfig","bundles","external","logger","info","dll","enhanceWithModifier","enhanceWithColor","bundlePath","manifestPath","copyBundle","filename","templates","bundleOutputDirectory","path","extname","dirname","isAbsolute","join","mkdirp","sync","fs","copyFileSync","existsSync","assetsOutputDirectory","cpx","copySync","assetsPath","preserve","webpackConfig","webpackConfigs","plugins","push","SimpleProgressWebpackPlugin","format","messages","initialBundleInformation","stats","build","print","bundleBuilt","error","done","complete","compiler","Promise","resolve","reject","run","err","hasErrors","Error","toJson","errorDetails","errors"],"mappings":"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","sourcesContent":["import { Arguments } from 'yargs';\nimport webpack from 'webpack';\nimport fs from 'fs';\nimport path from 'path';\nimport mkdirp from 'mkdirp';\nimport cpx from 'cpx';\nimport {\n  Runtime,\n  getProjectConfigPath,\n  getNormalizedProjectConfigBuilder,\n  sortBundlesByDependencies,\n  getBundleFilename,\n  EnvOptions,\n} from '@haul-bundler/core';\nimport * as messages from '../messages/multiBundleMessages';\nimport SimpleProgressWebpackPlugin from 'simple-progress-webpack-plugin';\n\nexport default function multiBundleCommand(runtime: Runtime) {\n  return {\n    command: 'multi-bundle',\n    describe: 'Create multiple bundles to be used in multi-bundle mode',\n    builder: {\n      dev: {\n        description:\n          'If false, warnings are disabled and the bundle is minified (default: true)',\n        default: true,\n        type: 'boolean',\n      },\n      platform: {\n        description: 'Either \"ios\" or \"android\" (default: \"ios\")',\n        type: 'string',\n      },\n      minify: {\n        description:\n          'Allows overriding whether bundle is minified. This defaults to false if dev is true, and true if dev is false. Disabling minification can be useful for speeding up production builds for testing purposes.',\n        type: 'boolean',\n      },\n      'bundle-output': {\n        description:\n          'Directory where to store generated bundles (filename is omitted if specified)',\n        type: 'string',\n      },\n      'assets-dest': {\n        description:\n          'Directory name where to store bundles and assets referenced in the bundle.',\n        type: 'string',\n      },\n      'sourcemap-output': {\n        description: 'File name where to store generated source map',\n        type: 'string',\n      },\n      config: {\n        description: 'Path to the CLI configuration file',\n        type: 'string',\n      },\n      progress: {\n        description:\n          'Display bundle compilation progress with different verbosity levels. Note that logging the compilation progress will increase build time. Defaults to `none` when you are building in production mode.',\n        choices: ['none', 'minimal', 'compact', 'expanded', 'verbose'],\n      },\n      'skip-host-check': {\n        description: 'Skips check for \"index\" or \"host\" bundle in Haul config',\n        type: 'boolean',\n      },\n      'max-workers': {\n        description: 'Number of workers used to load modules',\n        type: 'number',\n      },\n    },\n    async handler(\n      argv: Arguments<{\n        config?: string;\n        dev: boolean;\n        minify?: boolean;\n        platform: string;\n        assetsDest?: string;\n        bundleOutput?: string;\n        sourcemapOutput?: string;\n        progress: string;\n        skipHostCheck?: boolean;\n        maxWorkers?: number;\n      }>\n    ) {\n      try {\n        const {\n          config,\n          dev,\n          minify,\n          platform,\n          assetsDest,\n          bundleOutput,\n          sourcemapOutput,\n          progress,\n          skipHostCheck,\n          maxWorkers,\n        } = argv;\n\n        process.env.HAUL_PLATFORM = platform;\n\n        const directory = process.cwd();\n        const configPath = getProjectConfigPath(directory, config);\n        const normalizedProjectConfigBuilder = getNormalizedProjectConfigBuilder(\n          runtime,\n          configPath\n        );\n        const env: EnvOptions = {\n          platform,\n          root: directory,\n          dev,\n          bundleMode: 'multi-bundle',\n          bundleTarget: 'file',\n          bundleOutput,\n          assetsDest,\n          sourcemapOutput,\n          minify: minify === undefined ? !dev : minify,\n          maxWorkers,\n        };\n        const optionsWithProgress = {\n          ...env,\n          progress:\n            progress !== undefined\n              ? progress\n              : !dev\n              ? 'none'\n              : // Ensure that we don't trip Xcode's error detection. 'verbose' is the\n              // only level that doesn't make Xcode think that the bundle failed.\n              !process.stdin.isTTY\n              ? 'verbose'\n              : 'compact',\n        };\n        const projectConfig = normalizedProjectConfigBuilder(\n          runtime,\n          optionsWithProgress\n        );\n\n        for (const bundleName of sortBundlesByDependencies(projectConfig, {\n          skipHostCheck,\n        })) {\n          const bundleConfig = projectConfig.bundles[bundleName];\n          if (bundleConfig.external) {\n            runtime.logger.info(\n              `Using external${bundleConfig.dll ? ' DLL' : ''} bundle`,\n              runtime.logger.enhanceWithModifier('bold', bundleName)\n            );\n            runtime.logger.info(\n              'Bundle path',\n              runtime.logger.enhanceWithColor(\n                'gray',\n                bundleConfig.external.bundlePath\n              )\n            );\n            if (bundleConfig.dll) {\n              runtime.logger.info(\n                'Manifest path',\n                runtime.logger.enhanceWithColor(\n                  'gray',\n                  bundleConfig.external.manifestPath\n                )\n              );\n            }\n\n            if (bundleConfig.external.copyBundle) {\n              const filename = getBundleFilename(\n                env,\n                projectConfig.templates,\n                projectConfig.bundles[bundleName]\n              );\n              // `bundleOutput` should be a directory, but for backward-compatibility,\n              // we also handle the case with a filename.\n              let bundleOutputDirectory = bundleConfig.root;\n              if (env.bundleOutput) {\n                bundleOutputDirectory =\n                  path.extname(env.bundleOutput) === ''\n                    ? env.bundleOutput\n                    : path.dirname(env.bundleOutput);\n                bundleOutputDirectory = path.isAbsolute(bundleOutputDirectory)\n                  ? bundleOutputDirectory\n                  : path.join(bundleConfig.root, bundleOutputDirectory);\n              }\n              mkdirp.sync(bundleOutputDirectory);\n              runtime.logger.info(\n                'Copying bundle to',\n                runtime.logger.enhanceWithColor(\n                  'gray',\n                  path.join(bundleOutputDirectory, filename)\n                )\n              );\n              fs.copyFileSync(\n                bundleConfig.external.bundlePath,\n                path.join(bundleOutputDirectory, filename)\n              );\n              if (fs.existsSync(`${bundleConfig.external.bundlePath}.map`)) {\n                fs.copyFileSync(\n                  `${bundleConfig.external.bundlePath}.map`,\n                  path.join(bundleOutputDirectory, `${filename}.map`)\n                );\n                runtime.logger.info(\n                  'Copying bundle source maps to',\n                  runtime.logger.enhanceWithColor(\n                    'gray',\n                    path.join(bundleOutputDirectory, `${filename}.map`)\n                  )\n                );\n              }\n\n              let assetsOutputDirectory = bundleConfig.root;\n              if (env.assetsDest) {\n                assetsOutputDirectory = env.assetsDest;\n              } else if (env.bundleOutput) {\n                assetsOutputDirectory = env.bundleOutput;\n              }\n              assetsOutputDirectory = path.isAbsolute(assetsOutputDirectory)\n                ? assetsOutputDirectory\n                : path.join(bundleConfig.root, assetsOutputDirectory);\n\n              cpx.copySync(\n                path.join(\n                  bundleConfig.external.assetsPath,\n                  '**/*.{aac,aiff,bmp,caf,gif,html,jpeg,jpg,m4a,m4v,mov,mp3,mp4,mpeg,mpg,obj,otf,pdf,png,psd,svg,ttf,wav,webm,webp}'\n                ),\n                assetsOutputDirectory,\n                {\n                  preserve: true,\n                }\n              );\n            }\n            continue;\n          }\n\n          try {\n            const webpackConfig = projectConfig.webpackConfigs[bundleName];\n\n            // Attach progress plugin\n            if (progress !== 'none') {\n              webpackConfig.plugins!.push(\n                new SimpleProgressWebpackPlugin({\n                  format: progress,\n                }) as webpack.Plugin\n              );\n            }\n\n            messages.initialBundleInformation(runtime, {\n              bundleName,\n              webpackConfig,\n            });\n            const stats = await build(webpackConfig);\n            runtime.logger.print('');\n            messages.bundleBuilt(runtime, { stats });\n          } catch (error) {\n            runtime.logger.error(`${bundleName} bundle compilation failed`);\n            throw error;\n          }\n        }\n\n        runtime.logger.done(\n          'All bundles successfully compiled. You can now run your React Native multi-bundle app.'\n        );\n        runtime.complete();\n      } catch (error) {\n        runtime.logger.error(error);\n        runtime.complete(1);\n      }\n    },\n  };\n}\n\nfunction build(webpackConfig: webpack.Configuration) {\n  const compiler = webpack(webpackConfig);\n  return new Promise<webpack.Stats>((resolve, reject) =>\n    compiler.run((err, info) => {\n      if (err || info.hasErrors()) {\n        reject(\n          err\n            ? err\n            : new Error(info.toJson({ errorDetails: true }).errors.join('\\n'))\n        );\n      } else {\n        resolve(info);\n      }\n    })\n  );\n}\n"],"file":"multiBundle.js"}