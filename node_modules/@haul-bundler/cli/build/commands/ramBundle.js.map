{"version":3,"sources":["../../src/commands/ramBundle.ts"],"names":["ramBundleCommand","runtime","command","describe","builder","dev","description","default","type","platform","minify","config","progress","choices","handler","argv","assetsDest","bundleOutput","sourcemapOutput","indexedRamBundle","maxWorkers","process","env","HAUL_PLATFORM","webpackConfig","undefined","stdin","isTTY","bundleType","bundleMode","messages","initialInformation","initialBundleInformation","entry","compiler","stats","Promise","resolve","reject","run","err","info","hasErrors","buildFailed","toJson","errorDetails","errors","join","bundleBuilt","assetsPath","output","path","bundlePath","filename","complete","error","logger"],"mappings":"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","sourcesContent":["import { Arguments } from 'yargs';\nimport webpack from 'webpack';\nimport * as messages from '../messages/bundleMessages';\nimport { Runtime } from '@haul-bundler/core';\nimport prepareWebpackConfig from './shared/prepareWebpackConfig';\n\nexport default function ramBundleCommand(runtime: Runtime) {\n  return {\n    command: 'ram-bundle',\n    describe: 'Create ram-bundle',\n    builder: {\n      dev: {\n        description:\n          'If false, warnings are disabled and the bundle is minified (default: true)',\n        default: true,\n        type: 'boolean',\n      },\n      'entry-file': {\n        description:\n          'Path to the root JS file, either absolute or relative to JS root',\n        type: 'string',\n      },\n      platform: {\n        description: 'Either \"ios\" or \"android\" (default: \"ios\")',\n        type: 'string',\n      },\n      'indexed-ram-bundle': {\n        description:\n          'Force the \"Indexed RAM\" bundle file format, even when building for android.',\n        type: 'boolean',\n      },\n      minify: {\n        description:\n          'Allows overriding whether bundle is minified. This defaults to false if dev is true, and true if dev is false. Disabling minification can be useful for speeding up production builds for testing purposes.',\n        type: 'boolean',\n      },\n      'bundle-output': {\n        description:\n          'File name where to store the resulting bundle, ex. /tmp/groups.bundle.',\n        type: 'string',\n      },\n      'assets-dest': {\n        description:\n          'Directory name where to store assets referenced in the bundle.',\n        type: 'string',\n      },\n      'sourcemap-output': {\n        description: 'File name where to store generated source map',\n        type: 'string',\n      },\n      config: {\n        description: 'Path to the CLI configuration file',\n        type: 'string',\n      },\n      progress: {\n        description:\n          'Display bundle compilation progress with different verbosity levels. Note that logging the compilation progress will increase build time. Defaults to `none` when you are building in production mode.',\n        choices: ['none', 'minimal', 'compact', 'expanded', 'verbose'],\n      },\n      'max-workers': {\n        description:\n          'Number of workers used to minify RAM bundle and load modules',\n        type: 'number',\n      },\n    },\n    async handler(\n      argv: Arguments<{\n        config?: string;\n        dev: boolean;\n        minify?: boolean;\n        platform: string;\n        assetsDest?: string;\n        bundleOutput?: string;\n        sourcemapOutput?: string;\n        indexedRamBundle?: boolean;\n        progress: string;\n        maxWorkers?: number;\n      }>\n    ) {\n      try {\n        const {\n          config,\n          dev,\n          minify,\n          platform,\n          assetsDest,\n          bundleOutput,\n          sourcemapOutput,\n          progress,\n          indexedRamBundle,\n          maxWorkers,\n        } = argv;\n\n        process.env.HAUL_PLATFORM = platform;\n\n        const webpackConfig = prepareWebpackConfig(runtime, {\n          config,\n          dev,\n          minify: minify === undefined ? !dev : minify,\n          platform,\n          assetsDest,\n          bundleOutput,\n          sourcemapOutput,\n          progress:\n            progress !== undefined\n              ? progress\n              : !dev\n              ? 'none'\n              : // Ensure that we don't trip Xcode's error detection. 'verbose' is the\n              // only level that doesn't make Xcode think that the bundle failed.\n              !process.stdin.isTTY\n              ? 'verbose'\n              : 'compact',\n          bundleType:\n            !indexedRamBundle && platform == 'android'\n              ? 'file-ram-bundle'\n              : 'indexed-ram-bundle',\n          bundleMode: 'single-bundle',\n          maxWorkers,\n        });\n        messages.initialInformation(runtime, { config: webpackConfig });\n\n        messages.initialBundleInformation(runtime, {\n          entry: webpackConfig.entry,\n          dev,\n        });\n\n        const compiler = webpack(webpackConfig);\n        const stats = await new Promise<webpack.Stats>((resolve, reject) =>\n          compiler.run((err, info) => {\n            if (err || info.hasErrors()) {\n              messages.buildFailed(runtime);\n              reject(\n                err\n                  ? err\n                  : info.toJson({ errorDetails: true }).errors.join('\\n')\n              );\n            } else {\n              resolve(info);\n            }\n          })\n        );\n\n        messages.bundleBuilt(runtime, {\n          stats,\n          platform,\n          assetsPath: webpackConfig.output!.path,\n          bundlePath: webpackConfig.output!.filename as string,\n        });\n        runtime.complete();\n      } catch (error) {\n        runtime.logger.error(error);\n        runtime.complete(1);\n      }\n    },\n  };\n}\n"],"file":"ramBundle.js"}