{"version":3,"sources":["../../../src/webpack/resolvers/findProvidesModule.ts"],"names":["defaultOpts","blacklist","platforms","getJSFileName","fileName","exec","getPlatformFileName","realName","extension","isPlatformExtension","indexOf","name","ignoredPlatformExtension","getProvidedModuleName","segments","split","path","sep","length","findProvidesModule","directories","opts","options","modulesMap","walk","dir","stat","fs","statSync","isDirectory","readdirSync","forEach","file","join","isFile","jsFileName","moduleName"],"mappings":";;;;;;;AAAA;;AACA;;;;AAEA,MAAMA,WAAW,GAAG;AAClB;AACA;AACAC,EAAAA,SAAS,EAAE,CACT,cADS,EAET,WAFS,EAGT,WAHS,EAIT,cAJS,EAKT,gBALS,EAMT,aANS,EAOT,SAPS,CAHO;AAYlB;AACA;AACAC,EAAAA,SAAS,EAAE,CAAC,KAAD,EAAQ,SAAR,EAAmB,QAAnB,EAA6B,KAA7B;AAdO,CAApB;AAiBA;;;;AAGA,MAAMC,aAAa,GAAIC,QAAD,IAAsB;AAC1C,SAAO,CAAC,aAAaC,IAAb,CAAkBD,QAAlB,KAA+B,EAAhC,EAAoC,CAApC,CAAP;AACD,CAFD;AAIA;;;;;AAGA,MAAME,mBAAmB,GAAG,CAACF,QAAD,EAAmBF,SAAnB,KAA2C;AACrE;AACA,QAAM,GAAGK,QAAH,EAAaC,SAAb,IAA0B,gBAAgBH,IAAhB,CAAqBD,QAArB,KAAkC,CAChE,EADgE,EAEhE,EAFgE,EAGhE,EAHgE,CAAlE;AAMA,QAAMK,mBAAmB,GAAGP,SAAS,CAACQ,OAAV,CAAkBF,SAAlB,KAAgC,CAA5D,CARqE,CAUrE;;AACA,SAAO;AACLG,IAAAA,IAAI,EAAEF,mBAAmB,GAAGF,QAAH,GAAcH,QADlC;AAELQ,IAAAA,wBAAwB,EACtBJ,SAAS,IAAI,CAACC,mBAAd,IAAqCD,SAAS,KAAK;AAHhD,GAAP;AAKD,CAhBD;AAkBA;;;;;AAGA,MAAMK,qBAAqB,GAAIT,QAAD,IAAsB;AAClD;AACA,QAAMU,QAAQ,GAAGV,QAAQ,CAACW,KAAT,CAAeC,cAAKC,GAApB,CAAjB;AACA,SAAOH,QAAQ,CAACA,QAAQ,CAACI,MAAT,GAAkB,CAAnB,CAAf;AACD,CAJD;AAMA;;;;;;AAIe,SAASC,kBAAT,CAA4BC,WAA5B,EAAmDC,IAAI,GAAG,EAA1D,EAA8D;AAC3E,QAAMC,OAAqD,GAAG,EAC5D,GAAGtB,WADyD;AAE5D,OAAGqB;AAFyD,GAA9D;AAKA,QAAME,UAAqC,GAAG,EAA9C;;AAEA,QAAMC,IAAI,GAAIC,GAAD,IAAiB;AAC5B,UAAMC,IAAI,GAAGC,YAAGC,QAAH,CAAYH,GAAZ,CAAb;;AAEA,QAAIC,IAAI,CAACG,WAAL,EAAJ,EAAwB;AACtBF,kBAAGG,WAAH,CAAeL,GAAf,EAAoBM,OAApB,CAA4BC,IAAI,IAAI;AAClC,YAAIV,OAAO,CAACrB,SAAR,CAAkBS,OAAlB,CAA0BsB,IAA1B,KAAmC,CAAvC,EAA0C;AACxC;AACD;;AACDR,QAAAA,IAAI,CAACR,cAAKiB,IAAL,CAAUR,GAAV,EAAeO,IAAf,CAAD,CAAJ;AACD,OALD;;AAMA;AACD;;AAED,QAAIN,IAAI,CAACQ,MAAL,EAAJ,EAAmB;AACjB,YAAMC,UAAU,GAAGhC,aAAa,CAACsB,GAAD,CAAhC;;AACA,UAAI,CAACU,UAAL,EAAiB;AACf;AACD;;AAED,YAAM;AAAExB,QAAAA,IAAI,EAAEP,QAAR;AAAkBQ,QAAAA;AAAlB,UAA+CN,mBAAmB,CACtE6B,UADsE,EAEtEb,OAAO,CAACpB,SAF8D,CAAxE;;AAKA,UAAIU,wBAAJ,EAA8B;AAC5B;AACD;;AAED,YAAMwB,UAAU,GAAGvB,qBAAqB,CAACT,QAAD,CAAxC;;AACA,UAAI,CAACgC,UAAL,EAAiB;AACf;AACD,OAlBgB,CAoBjB;AACA;;AACA;;;;;;;AAKAb,MAAAA,UAAU,CAACa,UAAD,CAAV,GAAyBhC,QAAzB;AACD;AACF,GA1CD;;AA4CAgB,EAAAA,WAAW,CAACW,OAAZ,CAAoBP,IAApB;AAEA,SAAOD,UAAP;AACD","sourcesContent":["import fs from 'fs';\nimport path from 'path';\n\nconst defaultOpts = {\n  // An array of folders to ignore when building map of modules\n  // within given directory\n  blacklist: [\n    'node_modules',\n    '__tests__',\n    '__mocks__',\n    '__fixtures__',\n    'react-packager',\n    'androidTest',\n    'scripts',\n  ],\n  // An array of platform extensions to look for when locating\n  // modules\n  platforms: ['ios', 'android', 'native', 'web'],\n};\n\n/**\n * Returns Javascript file name or null for others\n */\nconst getJSFileName = (fileName: string) => {\n  return (/^(.*)\\.js$/.exec(fileName) || [])[1];\n};\n\n/**\n * Returns file name without platform extension (if present)\n */\nconst getPlatformFileName = (fileName: string, platforms: string[]) => {\n  // eslint-disable-next-line no-unused-vars\n  const [, realName, extension] = /^(.*)\\.(\\w+)$/.exec(fileName) || [\n    '',\n    '',\n    '',\n  ];\n\n  const isPlatformExtension = platforms.indexOf(extension) >= 0;\n\n  // StaticContainer.react would be dropped if we dont count react as a valid extension\n  return {\n    name: isPlatformExtension ? realName : fileName,\n    ignoredPlatformExtension:\n      extension && !isPlatformExtension && extension !== 'react',\n  };\n};\n\n/**\n * Returns name of the module provided by given file (if present)\n */\nconst getProvidedModuleName = (fileName: string) => {\n  // The provided module is the file name (excluding OS/platform extensions)\n  const segments = fileName.split(path.sep);\n  return segments[segments.length - 1];\n};\n\n/**\n * Recursively loops over given directories and returns a map of all\n * haste modules\n */\nexport default function findProvidesModule(directories: string[], opts = {}) {\n  const options: { blacklist: string[]; platforms: string[] } = {\n    ...defaultOpts,\n    ...opts,\n  };\n\n  const modulesMap: { [key: string]: string } = {};\n\n  const walk = (dir: string) => {\n    const stat = fs.statSync(dir);\n\n    if (stat.isDirectory()) {\n      fs.readdirSync(dir).forEach(file => {\n        if (options.blacklist.indexOf(file) >= 0) {\n          return;\n        }\n        walk(path.join(dir, file));\n      });\n      return;\n    }\n\n    if (stat.isFile()) {\n      const jsFileName = getJSFileName(dir);\n      if (!jsFileName) {\n        return;\n      }\n\n      const { name: fileName, ignoredPlatformExtension } = getPlatformFileName(\n        jsFileName,\n        options.platforms\n      );\n\n      if (ignoredPlatformExtension) {\n        return;\n      }\n\n      const moduleName = getProvidedModuleName(fileName);\n      if (!moduleName) {\n        return;\n      }\n\n      // Throw when duplicated modules are provided from a different\n      // fileName\n      /*\n      if (modulesMap[moduleName] && modulesMap[moduleName] !== fileName) {\n        throw new Error('Duplicate haste module found');\n      }\n      */\n      modulesMap[moduleName] = fileName;\n    }\n  };\n\n  directories.forEach(walk);\n\n  return modulesMap;\n}\n"],"file":"findProvidesModule.js"}